openapi: 3.0.0
info:
  title: WaterBallSA Authentication API
  version: 1.0.0
  description: |
    WaterBallSA 線上學習平台 - 認證 API 規格

    **認證方式**：Google OAuth 2.0 + JWT Token
    **Token 有效期**：Access Token (15分鐘) / Refresh Token (7天)
    **認證說明**：除登入端點外，所有受保護的 API 都需要在 Authorization header 中提供 JWT Bearer token

servers:
  - url: http://localhost:8081/api
    description: 開發環境
  - url: https://api.waterballsa.com/api
    description: 正式環境

paths:
  /auth/google:
    post:
      summary: Google OAuth 登入
      description: 使用 Google ID token 交換後端 JWT tokens
      operationId: loginWithGoogle
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - googleIdToken
              properties:
                googleIdToken:
                  type: string
                  description: Google OAuth ID token（從 Google 登入流程取得）
                  example: "eyJhbGciOiJSUzI1NiIsImtpZCI6IjE5ZmUyYTdiNjc5NTIzOTYwNmNhMGE3NTA3OTRhN2JkOWZkOTU5NjEiLCJ0eXAiOiJKV1QifQ..."
      responses:
        "200":
          description: 登入成功，返回 JWT tokens
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        "401":
          description: Google ID token 驗證失敗
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2025-12-08T10:30:00Z"
                status: 401
                error: "Unauthorized"
                message: "Invalid Google ID token"
                path: "/api/auth/google"
        "400":
          description: 請求格式錯誤
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /auth/refresh:
    post:
      summary: 刷新 Access Token
      description: 使用 Refresh Token 取得新的 Access Token
      operationId: refreshToken
      tags:
        - Authentication
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - refreshToken
              properties:
                refreshToken:
                  type: string
                  description: Refresh Token（從登入時取得）
                  example: "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwidHlwZSI6InJlZnJlc2giLCJpYXQiOjE2MzQwMjQwMDAsImV4cCI6MTYzNDYyODgwMH0..."
      responses:
        "200":
          description: Token 刷新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RefreshTokenResponse'
        "401":
          description: Refresh Token 無效或已過期
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2025-12-08T10:30:00Z"
                status: 401
                error: "Unauthorized"
                message: "Invalid or expired refresh token"
                path: "/api/auth/refresh"

  /auth/me:
    get:
      summary: 取得當前使用者資訊
      description: 取得當前已登入使用者的個人資料
      operationId: getCurrentUser
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 成功取得使用者資訊
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'
        "401":
          description: 未提供有效的 JWT token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                timestamp: "2025-12-08T10:30:00Z"
                status: 401
                error: "Unauthorized"
                message: "JWT token is missing or invalid"
                path: "/api/auth/me"

  /auth/logout:
    post:
      summary: 登出
      description: 登出當前使用者（客戶端清除 tokens）
      operationId: logout
      tags:
        - Authentication
      security:
        - BearerAuth: []
      responses:
        "200":
          description: 登出成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Logout successful"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT access token（格式：Bearer {token}）

  schemas:
    AuthResponse:
      type: object
      required:
        - accessToken
        - refreshToken
        - tokenType
        - expiresIn
      properties:
        accessToken:
          type: string
          description: JWT access token（用於 API 認證）
          example: "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNjM0MDI0MDAwLCJleHAiOjE2MzQwMjQ5MDB9..."
        refreshToken:
          type: string
          description: Refresh token（用於刷新 access token）
          example: "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwidHlwZSI6InJlZnJlc2giLCJpYXQiOjE2MzQwMjQwMDAsImV4cCI6MTYzNDYyODgwMH0..."
        tokenType:
          type: string
          description: Token 類型（固定為 Bearer）
          example: "Bearer"
        expiresIn:
          type: integer
          description: Access token 有效時間（秒）
          example: 900

    RefreshTokenResponse:
      type: object
      required:
        - accessToken
        - tokenType
        - expiresIn
      properties:
        accessToken:
          type: string
          description: 新的 JWT access token
          example: "eyJhbGciOiJIUzUxMiJ9.eyJzdWIiOiJ1c2VyQGV4YW1wbGUuY29tIiwiaWF0IjoxNjM0MDI0MDAwLCJleHAiOjE2MzQwMjQ5MDB9..."
        tokenType:
          type: string
          description: Token 類型（固定為 Bearer）
          example: "Bearer"
        expiresIn:
          type: integer
          description: Access token 有效時間（秒）
          example: 900

    User:
      type: object
      required:
        - id
        - googleId
        - email
        - name
        - createdAt
        - updatedAt
      properties:
        id:
          type: integer
          description: 使用者 ID
          example: 1
        googleId:
          type: string
          description: Google 使用者 ID
          example: "108123456789012345678"
        email:
          type: string
          format: email
          description: 使用者電子郵件
          example: "user@example.com"
        name:
          type: string
          description: 使用者姓名
          example: "John Doe"
        profilePicture:
          type: string
          format: uri
          description: 使用者頭像 URL（可選）
          example: "https://lh3.googleusercontent.com/a/example"
        createdAt:
          type: string
          format: date-time
          description: 建立時間
          example: "2025-01-01T00:00:00Z"
        updatedAt:
          type: string
          format: date-time
          description: 最後更新時間
          example: "2025-01-15T12:30:00Z"

    ErrorResponse:
      type: object
      required:
        - timestamp
        - status
        - error
        - message
        - path
      properties:
        timestamp:
          type: string
          format: date-time
          description: 錯誤發生時間
          example: "2025-12-08T10:30:00Z"
        status:
          type: integer
          description: HTTP 狀態碼
          example: 400
        error:
          type: string
          description: 錯誤類型
          example: "Bad Request"
        message:
          type: string
          description: 錯誤訊息
          example: "Invalid request parameters"
        path:
          type: string
          description: 請求路徑
          example: "/api/auth/google"
        validationErrors:
          type: object
          additionalProperties:
            type: string
          description: 驗證錯誤詳情（可選）
          example:
            googleIdToken: "不得為空"
